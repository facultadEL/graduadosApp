<!DOCTYPE html>
<html lang="en">
<head>
	<link type="text/css" rel="stylesheet" href="css/materialize.css"  media="screen,projection"/>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<link type="text/css" rel="stylesheet" href="css/estilo.css"  media="screen,projection"/>
	<title>Graduados</title>
</head>
<body>
<nav>
	<div class="nav-wrapper blue darken-4">
		<a href="inicio.html" class="brand-logo center">Graduados FRVM</a>
		<a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
		<ul class="left hide-on-med-and-down">
			<li><a href="perfil.html"><i class="material-icons">perm_identity</i></a></li>
		</ul>
		<ul class="right hide-on-med-and-down">
            <li class="hideNotAdmin"><a class="graduadosHref" href="graduadosAdmin.html"><strong>Graduados</strong> <span class="new badge cantGraduados">0</span></a></li>
			<li><a href="cursosAdmin.html">Cursos</a></li>
			<li><a href="posgradosAdmin.html">Posgrados</a></li>
			<li><a href="empleoAdmin.html">Empleo</a></li>
			<li><a href="#" onclick="logout()"><i class="material-icons">power_settings_new</i></a></li>
		</ul>
		<ul class="side-nav" id="mobile-demo">
			<li><a href="perfil.html">Perfil</a></li>
            <li class="hideNotAdmin"><a class="graduadosHref" href="graduadosAdmin.html"><strong>Graduados</strong> <span class="new badge cantGraduados">0</span></a></li>
			<li><a href="cursosAdmin.html">Cursos</a></li>
			<li><a href="posgradosAdmin.html">Posgrados</a></li>
			<li><a href="empleoAdmin.html">Empleo</a></li>
			<li><a href="#" onclick="logout()">Cerrar Sesión</a></li>
		</ul>
	</div>
</nav>
<div class="container">
    <ul class="collection" id="graduadosUl">
		
    </ul>
	<div class="fixed-action-btn vertical" style="bottom: 45px; right: 24px;">
		<a class="btn-floating btn-large blue darken-4" onclick="habilitar()">
			<i class="material-icons" id="iconEdit">done</i>
		</a>
	</div>
	<div class="footer-copyright right-align">
		<div class="container">
			<i>© 2016 UTN FRVM</i>
		</div>
	</div>
</div>
<script src="js/jquery-2.1.1.min.js"></script>
<script src="js/materialize.js"></script>
<script src="js/functions.js"></script>
<script>
var graduados;
function setCantidad()
{
	var storage = window.localStorage;
	var cant = storage.getItem('cantidad');
	if(parseInt(cant) > 0)
	{
		$('.cantGraduados').html(cant);
	}
	else
	{
		$('.cantGraduados').hide();
	}
}

function getGraduados()
{
	var storage = window.localStorage;
	var id = storage.getItem('id');
	
	var param = {
		"id":id
	};
	
	$.ajax({
		type:"POST",
		url:"http://extension.frvm.utn.edu.ar/graduadosApi/getGraduadosHabilitar.php",
		data: param,
		success: function(response)
		{
			var r = JSON.parse(response);
			successGetGraduados(r);
		},
		error: function(msg)
		{
			toasty('Error al traer graduados','error');
		}
	});
}

function successGetGraduados(data)
{
	graduados = data;
	var htmlGrad = '';
	var dLength = data.length;
	for(var i = 0; i < dLength; i++)
	{
		var g = data[i];
		var text = `${g.apellido}, ${g.nombre} - ${g.dni}`;
		if(text.length > 40)
		{
			if(g.nombre.length > 6)
			{
				var n = g.nombre.substring(0,6) + '...';
				text = `${g.apellido}, ${n} - ${g.dni}`
			}
		}
		htmlGrad += `<li class="collection-item"><div><label for="gradCheck-${g.id}" id="gradLabel">${text}</label><div class="secondary-content"><input type="checkbox" class="filled-in" id="gradCheck-${g.id}" /><label for="gradCheck-${g.id}" id="checkGrad"></label></div></div></li>`;
	}
	
	$('#graduadosUl').html(htmlGrad);	
}

function habilitar()
{
	var data = graduados;
	var dLength = data.length;
	var count = 0;
	var idHabilitar = '';
	for(var i = 0; i < dLength; i++)
	{
		var g = data[i];
		var name = `#gradCheck-${g.id}`;
		if($(name).is(':checked'))
		{
			count++;
			idHabilitar += `${g.id}/--/`;
		}
	}
	
	if(count > 0)
	{
		var param = {
			"idHabilitar":idHabilitar
		};
		
		$.ajax({
			type:"POST",
			data:param,
			url:"http://extension.frvm.utn.edu.ar/graduadosApi/habilitarGraduado.php",
			success: function(response)
			{
				var r = JSON.parse(response);
				if(r[0].success == 't')
				{
					getGraduados();
				}
				else
				{
					toasty('Hubo un problema al habilitar los graduados','error');
				}
			}
		});
	}
	else
	{
		toasty('Seleccione al menos un graduado','error');
	}
}

$(document).ready(function()
{
	$(".button-collapse").sideNav();
    setCantidad();
	getGraduados();
});

</script>
</body>
</html>