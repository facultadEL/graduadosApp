<!DOCTYPE html>
<html lang="es">
<head>
	<title>Registro</title>
	<!--<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">-->
	<!--<link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>-->
	<link type="text/css" rel="stylesheet" href="css/materialize.css"  media="screen,projection"/>
	<link type="text/css" rel="stylesheet" href="css/estilo.css"  media="screen,projection"/>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<!--<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>-->
</head>
<body>


    <div class="container-fluid">
	    <div class="navbar-fixed">
	        <nav>
	            <div class="nav-wrapper nav-bar-fixed blue darken-4">
	                <a href="registro.html" class="brand-logo center">Registro</a>
	            </div>
	        </nav>
	    </div>
    </div>
    <div class="container">

        <div class="card-panel blue lighten-5">

            <div class="row">

                <form class="col s12" id="form" onsubmit="return controlSubmit();">

                    <h6 class="black-text">Datos personales</h6>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="input-field col s6">
                        	<input type="hidden" id="id" />
                            <input id="first_name" type="text" onkeydown="sacarColor(this)">
                            <label for="first_name">Nombre</label>
                        </div>
                        <div class="input-field col s6">
                            <input id="last_name" type="text" onkeydown="sacarColor(this)">
                            <label for="last_name">Apellido</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                            <input id="dni" type="number" onkeydown="sacarColor(this)" onblur="checkDni()">
                            <label for="dni">DNI</label>
                        </div>
                        <div class="input-field col s6">
                            <input id="loc" type="text" onkeydown="sacarColor(this)">
                            <label for="loc">Localidad</label>
                        </div>
                    </div>

					<div class="row">
                        <div class="input-field col s12" id="divProvincia">
                        </div>
                    </div>
					<div class="row">
						<div class="input-field col s12" id="divLocalidad">
						</div>
					</div>

                    <h6 class="black-text">Contacto</h6>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="email" type="email" onkeydown="sacarColor(this)">
                            <label for="email">Correo</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                        	<input type="hidden" id="carCId" />
                            <input id="carCel" type="text" onkeydown="sacarColor(this)">
                            <label for="carCel">Caracter&iacute;stica (Sin 0)</label>
                        </div>
                        <div class="input-field col s6">
                        	<input type="hidden" id="ceId" />
                            <input id="cel" type="text" onkeydown="sacarColor(this)">
                            <label for="cel">Celular (Sin 15)</label>
                        </div>
                    </div>
					<div class="row">
						<div class="input-field col s6">
							<input type="hidden" id="carTId" />
							<input id="carFijo" type="text" onkeydown="sacarColor(this)">
							<label for="carFijo">Caracter&iacute;stica (Sin 0)</label>
						</div>
						<div class="input-field col s6">
							<input type="hidden" id="fijoId" />
							<input id="fijo" type="text" onkeydown="sacarColor(this)">
							<label for="fijo">Tel&eacute;fono fijo</label>
						</div>
					</div>

                    <h6 class="black-text">Datos de cuenta</h6>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="username" type="text" onkeydown="sacarColor(this)">
                            <label for="username">Nombre Usuario</label>
                        </div>
					</div>
					<div class="row">
						<div class="input-field col s6">
							<input placeholder="Al menos 6 caracteres" id="password" type="password" onkeydown="sacarColor(this)" pattern=".{6,}"  onchange="this.setCustomValidity(this.validity.patternMismatch ? 'Debe tener al menos 6 caracteres' : ''); if(this.checkValidity()) form.passwordRep.pattern = this.value; if(this.value.length > 0) {form.passwordRep.setAttribute('required',true);}else{if(form.password.getAttribute('required')){form.passwordRep.setAttribute('required',true);}else{form.passwordRep.setAttribute('required',false);}}">
							<label for="password">Contraseña</label>
						</div>
						<div class="input-field col s6">
							<input placeholder="Al menos 6 caracteres" id="passwordRep" type="password" onkeydown="sacarColor(this)" pattern=".{6,}" onchange="this.setCustomValidity(this.validity.patternMismatch ? 'Ingrese la misma contraseña' : '');">
							<label for="passwordRep">Repita Contraseña</label>
						</div>
					</div>

                    <div class="center-align">
                        <button class="btn waves-effect light-blue darken-3" type="submit" name="action">Registrarme
                            <i class="material-icons right">done</i>
                        </button>
                    </div>
                </form>
            </div>

        </div>
        <div class="footer-copyright right-align">
            <div class="container">
                <i>© 2016 UTN FRVM</i>
            </div>
        </div>
    </div>


    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
	<script defer>

	var passRequired = false;

	function controlVacio(nombreSelector)
	{
		if($.trim($(nombreSelector).val()) == '')
		{
			$(nombreSelector).css('box-shadow','0px 0px 1px 1px #f24d4d');
			$(nombreSelector).focus();
			return false;
		}
		return true;
	}

	function sacarColor(me)
	{
		$(me).css('box-shadow','0px 0px 0px 0px #ccc');
	}

	function controlSubmit()
	{
		if(!controlVacio('#first_name')) return false;
		if(!controlVacio('#last_name')) return false;
		if(!controlVacio('#dni')) return false;
		if(!controlVacio('#loc')) return false;
		if(!controlVacio('#email')) return false;
		//if(!controlVacio('#cel')) return false;
		//if(!controlVacio('#fijo')) return false;
		if(!controlVacio('#username')) return false;
		if(passRequired)
		{
			if(!controlVacio('#password')) return false;
		}

		var param = {
			"id":($('#id').val()),
			"nombre":($('#first_name').val()),
			"apellido":($('#last_name').val()),
			"dni":($('#dni').val()),
			"localidad":($('#loc').val()),
			"email":($('#email').val()),
			"caracCel":($('#carCel').val()),
			"cel":($('#cel').val()),
			"caracFijo":($('#carFijo').val()),
			"fijo":($('#fijo').val()),
			"username":($('#username').val()),
			"passRequired": passRequired,
			"password":($('#password').val()),
			"celId":($('#celId').val()),
			"fijoId":($('#fijoId').val())
		}

		$.ajax({
			type:"POST",
			data: param,
			url: "http://extension.frvm.utn.edu.ar/graduadosApi/guardarDatos.php",
			success: function(response)
			{
				var r = JSON.parse(response);
				if(r[0].success)
				{
					if(r[0].created)
					{
						window.location.href="index.html";
					}
					else
					{
						window.location.href="inicio.html";
					}
				}
				else
				{
					alert("No se pudo guardar");
				}
			},
			error: function(msg)
			{
				alert("Hubo un error al guardar los datos");
			}
		});

		return false;
	}

	function getDatos()
	{
		$.ajax({
			type:"GET",
			url:"http://extension.frvm.utn.edu.ar/graduadosApi/getDataById.php",
			success: function(response)
			{
				var r = JSON.parse(response);
				successGetDatos(r[0]);
			},
			error: function(msg)
			{
				alert(`Hubo un error al buscar los datos. Error: ${msg}`);
			}
		});
	}

	function successGetDatos(data)
	{
		if(data.primerLogin == 't')
		{
			passRequired = true;
			$('#password').prop('required',true);
		}

		$('#id').val(data.id);
		$('#first_name').val(data.nombre);
		$('#first_name').focus();
		$('#last_name').val(data.apellido);
		$('#last_name').focus();
		$('#dni').val(data.dni);
		$('#dni').focus();
		$('#loc').val(data.localidad);
		$('#loc').focus();
		$('#email').val(data.email);
		$('#email').focus();
		$('#celId').val(data.celId);
		$('#carCel').val(data.caracCel);
		$('#carCel').focus();
		$('#cel').val(data.cel);
		$('#cel').focus();
		$('#fijoId').val(data.fijoId);
		$('#carFijo').val(data.caracFijo);
		$('#carFijo').focus();
		$('#fijo').val(data.fijo);
		$('#fijo').focus();
		$('#username').val(data.username);
		$('#username').focus();
		$('#username').blur();

		if(data.id == "-1")
		{
			$('#dni').focus();
		}
	}

	function checkDni()
	{
		var dni = $('#dni').val().trim();
		if(dni != '')
		{
			if($('#id').val() == -1)
			{
				
				var param = {
					"dni":dni
				};

				$.ajax({
					type:"POST",
					data: param,
					url:"http://extension.frvm.utn.edu.ar/graduadosApi/checkDni.php",
					success: function(response)
					{
						var r = JSON.parse(response);
						if(r.length > 0)
						{
							successGetDatos(r[0]);
						}
						else
						{
							$('#id').val('-1');
							$('#first_name').focus();
						}
					},
					error: function(msg)
					{
						alert("Se ha generado un error al ir a buscar los datos por DNI");
					}
				});
			}
		}
	}

	function getProvincia()
	{
		$.ajax({
			type:"GET",
			url:"http://extension.frvm.utn.edu.ar/graduadosApi/getProvincia.php",
			success: function(response)
			{
				var r = JSON.parse(response);
				successGetProvincia(r);
			},
			error: function(msg)
			{
				toasty('Se ha generado un error al buscar las provincias','danger');
			}
		});
	}

	function successGetProvincia(r)
	{
		var htmlProvincias = `<select id="selProvincia" onchange="getLocalidad()">`;
		for(var i = 0; i < r.length; i++)
		{
			var val = r[i].val;
			var name = r[i].name;
			htmlProvincias += `<option value="${val}">${name}</option>`;
		}
		htmlProvincias += `</select><label>Provincia</label>`;
		
		$('#divProvincia').html(htmlProvincias);
		$('select').material_select();
	}
	
	function getLocalidad()
	{
		var valProvincia = $('#selProvincia').val();
		if(valProvincia != 0)
		{
			var param = {
				"provincia":valProvincia
			}
			
			$.ajax({
				type:"POST",
				url:"http://extension.frvm.utn.edu.ar/graduadosApi/getLocalidad.php",
				data:param,
				success: function(response)
				{
					var r = JSON.parse(response);
					successGetLocalidad(r);
				},
				error: function(msg)
				{
					toasty('Se produjo un error al traer las localidades','danger');
				}
			});
		}
		else
		{
			toasty('Seleccione una provincia','danger');
		}
	}
	
	function successGetLocalidad(r)
	{
		var htmlLocalidad = `<select id="selLocalidad">`;
		for(var i = 0; i < r.length; i++)
		{
			var val = r[i].val;
			var name = r[i].name;
			htmlLocalidad += `<option value="${val}">${name}</option>`;
		}
		htmlLocalidad += `</select><label>Localidad</label>`;
		
		$('#divLocalidad').html(htmlLocalidad);
		$('select').material_select();
	}

	$(document).ready(function(){
		getProvincia();
		getDatos();
	
	});

	</script>
</body>
</html>