<!DOCTYPE html>
<html lang="es">
<head>
	<title>Registro</title>
	<!--<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">-->
	<!--<link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>-->
	<link type="text/css" rel="stylesheet" href="css/materialize.css"  media="screen,projection"/>
	<link type="text/css" rel="stylesheet" href="css/estilo.css"  media="screen,projection"/>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<!--<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>-->
</head>
<body>


    <div class="container-fluid">
	    <div class="navbar-fixed">
	        <nav>
	            <div class="nav-wrapper nav-bar-fixed blue darken-4">
	                <a href="registro.html" class="brand-logo center">Registro</a>
	            </div>
	        </nav>
	    </div>
    </div>
    <div class="container">
		<div class="preloader-wrapper active" id="loader">
			<div class="spinner-layer spinner-blue-only">
				<div class="circle-clipper left">
					<div class="circle"></div>
				</div>
				<div class="gap-patch">
					<div class="circle"></div>
				</div>
				<div class="circle-clipper right">
					<div class="circle"></div>
				</div>
			</div>
		</div>
        <div class="card-panel blue lighten-5">

            <div class="row">

                <form class="col s12" id="form" onsubmit="return controlSubmit();">

                    <h6 class="black-text">Datos personales</h6>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="input-field col s6">
                        	<input type="hidden" id="id" />
                            <input id="first_name" type="text" onkeydown="sacarColor(this)">
                            <label for="first_name">Nombre</label>
                        </div>
                        <div class="input-field col s6">
                            <input id="last_name" type="text" onkeydown="sacarColor(this)">
                            <label for="last_name">Apellido</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                            <input id="dni" type="number" onkeydown="sacarColor(this)" onblur="checkDni()" placeholder="Sin puntos">
                            <label for="dni">DNI</label>
                        </div>
                        <div class="input-field col s6">
                            <!--<input id="loc" type="text" onkeydown="sacarColor(this)">-->
							<input type="date" id="fechanac" class="datepicker" placeholder="dd/mm/aaa">
                            <label for="fechanac">Fecha Nac.</label>
                        </div>
                    </div>
					<div class="row">
						<div class="input-field col s12">
							<label class="active">Localidad</label>
							<input type="text" id="autocompleteState" class="autocomplete inputFields">
						</div>
					</div>

                    <h6 class="black-text">Contacto</h6>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="email" type="email" onkeydown="sacarColor(this)">
                            <label for="email">Correo</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                        	<input type="hidden" id="carCId" />
                            <input id="carCel" type="text" onkeydown="sacarColor(this)">
                            <label for="carCel">Caracter&iacute;stica (Sin 0)</label>
                        </div>
                        <div class="input-field col s6">
                        	<input type="hidden" id="ceId" />
                            <input id="cel" type="text" onkeydown="sacarColor(this)">
                            <label for="cel">Celular (Sin 15)</label>
                        </div>
                    </div>
					<div class="row">
						<div class="input-field col s6">
							<input type="hidden" id="carTId" />
							<input id="carFijo" type="text" onkeydown="sacarColor(this)">
							<label for="carFijo">Caracter&iacute;stica (Sin 0)</label>
						</div>
						<div class="input-field col s6">
							<input type="hidden" id="fijoId" />
							<input id="fijo" type="text" onkeydown="sacarColor(this)">
							<label for="fijo">Tel&eacute;fono fijo</label>
						</div>
					</div>

                    <h6 class="black-text">Datos de cuenta</h6>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="username" type="text" onkeydown="sacarColor(this)">
                            <label for="username">Nombre Usuario</label>
                        </div>
					</div>
					<div class="row">
						<div class="input-field col s6">
							<input placeholder="Al menos 6 caracteres" id="password" type="password" onkeydown="sacarColor(this)" pattern=".{6,}"  onchange="this.setCustomValidity(this.validity.patternMismatch ? 'Debe tener al menos 6 caracteres' : ''); if(this.checkValidity()) form.passwordRep.pattern = this.value; if(this.value.length > 0) {form.passwordRep.setAttribute('required',true);}else{if(form.password.getAttribute('required')){form.passwordRep.setAttribute('required',true);}else{form.passwordRep.setAttribute('required',false);}}">
							<label for="password">Contraseña</label>
						</div>
						<div class="input-field col s6">
							<input placeholder="Al menos 6 caracteres" id="passwordRep" type="password" onkeydown="sacarColor(this)" pattern=".{6,}" onchange="this.setCustomValidity(this.validity.patternMismatch ? 'Ingrese la misma contraseña' : '');">
							<label for="passwordRep">Repita Contraseña</label>
						</div>
					</div>

                    <div class="center-align">
                        <button class="btn waves-effect light-blue darken-3" type="submit" name="action">Registrarme
                            <i class="material-icons right">done</i>
                        </button>
                    </div>
                </form>
            </div>

        </div>
        <div class="footer-copyright right-align">
            <div class="container">
                <i>© 2016 UTN FRVM</i>
            </div>
        </div>
    </div>


    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
	<script type="text/javascript" src="js/functions.js"></script>
	<script defer>

	var passRequired = false;

	function controlVacio(nombreSelector)
	{
		if($.trim($(nombreSelector).val()) == '')
		{
			$(nombreSelector).css('box-shadow','0px 0px 1px 1px #f24d4d');
			$(nombreSelector).focus();
			return false;
		}
		return true;
	}

	function sacarColor(me)
	{
		$(me).css('box-shadow','0px 0px 0px 0px #ccc');
	}

	function formatDate(date)
	{
		var vDate = date.split(',');
		var year = vDate[1].trim();
		var monthName = vDate[0].split(' ')[1].toLowerCase();
		var day = vDate[0].split(' ')[0];
		var month = 0;
		switch(monthName)
		{
			case 'january':
				month = 1;
				break;
			case 'february':
				month = 2;
				break;
			case 'march':
				month = 3;
				break;
			case 'april':
				month = 4;
				break;
			case 'may':
				month = 5;
				break;
			case 'june':
				month = 6;
				break;
			case 'july':
				month = 7;
				break;
			case 'august':
				month = 8;
				break;
			case 'september':
				month = 9;
				break;
			case 'october':
				month = 10;
				break;
			case 'november':
				month = 11;
				break;
			case 'december':
				month = 12;
				break;
		}
		
		return `${year}-${month}-${day}`;
	}

	function controlSubmit()
	{
		if(!controlVacio('#first_name')) return false;
		if(!controlVacio('#last_name')) return false;
		if(!controlVacio('#dni')) return false;
		if(!controlVacio('#autocompleteState')) return false;
		if(!controlVacio('#email')) return false;
		//if(!controlVacio('#cel')) return false;
		//if(!controlVacio('#fijo')) return false;
		if(!controlVacio('#username')) return false;
		if(passRequired)
		{
			if(!controlVacio('#password')) return false;
		}

		var birthDate = formatDate($('#fechanac').val());

		var param = {
			"id":($('#id').val()),
			"nombre":($('#first_name').val()),
			"apellido":($('#last_name').val()),
			"dni":($('#dni').val()),
			"localidad":($('#loc').val()),
			"email":($('#email').val()),
			"caracCel":($('#carCel').val()),
			"cel":($('#cel').val()),
			"caracFijo":($('#carFijo').val()),
			"fijo":($('#fijo').val()),
			"username":($('#username').val()),
			"passRequired": passRequired,
			"password":($('#password').val()),
			"celId":($('#celId').val()),
			"fijoId":($('#fijoId').val()),
			"birthDate":birthDate
		}
		$('#loader').show();
		$.ajax({
			type:"POST",
			data: param,
			url: "http://extension.frvm.utn.edu.ar/graduadosApi/guardarDatos.php",
			success: function(response)
			{
				$('#loader').hide();
				var r = JSON.parse(response);
				if(r[0].success)
				{
					if(r[0].created)
					{
						window.location.href="index.html";
					}
					else
					{
						var storage = window.localStorage;
						storage.setItem('id', $('#id').val());
						window.location.href="inicio.html";
					}
				}
				else
				{
					alert("No se pudo guardar");
				}
			},
			error: function(msg)
			{
				alert("Hubo un error al guardar los datos");
			}
		});

		return false;
	}

	function getDatos()
	{
		$.ajax({
			type:"GET",
			url:"http://extension.frvm.utn.edu.ar/graduadosApi/getDataById.php",
			success: function(response)
			{
				var r = JSON.parse(response);
				successGetDatos(r[0]);
			},
			error: function(msg)
			{
				alert(`Hubo un error al buscar los datos. Error: ${msg}`);
			}
		});
	}

	function successGetDatos(data)
	{
		if(data.primerLogin == 't')
		{
			passRequired = true;
			$('#password').prop('required',true);
		}

		$('#id').val(data.id);
		$('#first_name').val(data.nombre);
		$('#first_name').focus();
		$('#last_name').val(data.apellido);
		$('#last_name').focus();
		$('#dni').val(data.dni);
		$('#dni').focus();
		$('#loc').val(data.localidad);
		$('#loc').focus();
		$('#email').val(data.email);
		$('#email').focus();
		$('#celId').val(data.celId);
		$('#carCel').val(data.caracCel);
		$('#carCel').focus();
		$('#cel').val(data.cel);
		$('#cel').focus();
		$('#fijoId').val(data.fijoId);
		$('#carFijo').val(data.caracFijo);
		$('#carFijo').focus();
		$('#fijo').val(data.fijo);
		$('#fijo').focus();
		$('#username').val(data.username);
		$('#username').focus();
		$('#username').blur();

		if(data.id == "-1")
		{
			$('#dni').focus();
		}
	}

	function checkDni()
	{
		var dni = $('#dni').val().trim();
		if(dni != '')
		{
			if($('#id').val() == -1)
			{
				
				var param = {
					"dni":dni
				};

				$.ajax({
					type:"POST",
					data: param,
					url:"http://extension.frvm.utn.edu.ar/graduadosApi/checkDni.php",
					success: function(response)
					{
						var r = JSON.parse(response);
						if(r.length > 0)
						{
							successGetDatos(r[0]);
						}
						else
						{
							$('#id').val('-1');
							$('#first_name').focus();
						}
					},
					error: function(msg)
					{
						alert("Se ha generado un error al ir a buscar los datos por DNI");
					}
				});
			}
		}
	}
	
	function successGetLocalidad(r)
	{
		/*
		var htmlLocalidad = `<select id="selLocalidad">`;
		for(var i = 0; i < r.length; i++)
		{
			var val = r[i].val;
			var name = r[i].name;
			htmlLocalidad += `<option value="${val}">${name}</option>`;
		}
		htmlLocalidad += `</select><label>Localidad</label>`;
		
		$('#divLocalidad').html(htmlLocalidad);
		$('select').material_select();
		*/
		
		var localidadData = [];
		
		for(var i = 0; i < r.length; i++)
		{
			var obj = {value:r[i].name};
			localidadData.push(obj);
		}
		
		$('#autocompleteState').data('array', localidadData);
		
		var input_selector = 'input[type=text], input[type=password], input[type=email], input[type=url], input[type=tel], input[type=number], input[type=search], textarea';
		
		$(input_selector).each(function() {
			var $input = $(this);

			if ($input.hasClass('autocomplete'))
			{
				var $array = $input.data('array');
				var $inputDiv = $input.closest('.input-field'); // Div to append on
				if ($array !== '')
				{
					var $html = '<ul class="autocomplete-content hide" style="z-index:1;">';
					for (var i = 0; i < $array.length; i++)
					{
						if ($array[i]['path'] !== '' && $array[i]['path'] !== undefined && $array[i]['path'] !== null && $array[i]['class'] !== undefined && $array[i]['class'] !== '') {
							$html += '<li class="autocomplete-option"><img src="' + $array[i]['path'] + '" class="' + $array[i]['class'] + '"><span>' + $array[i]['value'] + '</span></li>';
						} else {
							$html += '<li class="autocomplete-option"><span>' + $array[i]['value'] + '</span></li>';
						}
					}
					$html += '</ul>';
					$inputDiv.append($html); // Set ul in body
					// End create html element
					/*
					function highlight(string)
					{
						$('.autocomplete-content li').each(function()
						{
							var matchStart = $(this).text().toLowerCase().indexOf("" + string.toLowerCase() + ""),
							matchEnd = matchStart + string.length - 1,
							beforeMatch = $(this).text().slice(0, matchStart),
							matchText = $(this).text().slice(matchStart, matchEnd + 1),
							afterMatch = $(this).text().slice(matchEnd + 1);
							$(this).html("<span>" + beforeMatch + "<span class='highlight'>" + matchText + "</span>" + afterMatch + "</span>");
						});
					}
					*/
					var lengthWord = 0;
					// Perform search
					$(document).on('keyup', $input, function()
					{
						var quantity = 0;
						var $val = $input.val().trim(),
						$select = $('.autocomplete-content');
						
						$select.css('width',$input.width());

						var length = $val.length;
						if ($val != '' && $val.length >= 3 && length > lengthWord)
						{
							lengthWord = length
							$select.children('li').addClass('hide');
							$select.children('li').filter(function()
							{
								$select.removeClass('hide'); // Show results

								/*
								if ($input.hasClass('highlight-matching')) {
									highlight($val);
								}
								*/
								var check = true;
								if($(this).text().toLowerCase().indexOf($val.toLowerCase()) == -1)
								{
									check = false;
								}
								if(check)
								{
									if(quantity < 5)
									{
										quantity++;
									}
									else
									{
										check = false;
									}	
								}
								
								return check ? $(this).text().toLowerCase().indexOf($val.toLowerCase()) !== -1 : false;
							}).removeClass('hide');	
						}
						else
						{
							lengthWord = length;
							$select.children('li').addClass('hide');
						}
					});

					// Set input value
					$('.autocomplete-option').click(function()
					{
						$input.val($(this).text().trim());
						$('.autocomplete-option').addClass('hide');
					});
				}
				else
				{
					return false;
				}
			}
		});
	}

	function getDataLocalidad()
	{
		$.ajax({
			type:'POST',
			url: 'http://extension.frvm.utn.edu.ar/graduadosApi/getLocalidad.php',
			success: function(response)
			{
				var r = JSON.parse(response);
				successGetLocalidad(r);
			},
			error: function(msg)
			{
				alert('Error al traer localidades');
			}
		});
	}

	$(document).ready(function(){
		$('#loader').hide();
		getDataLocalidad();
		getDatos();
		$('.datepicker').pickadate({
			selectMonths: true, // Creates a dropdown to control month
			selectYears: 100 // Creates a dropdown of 15 years to control year
		});
	});

	</script>
</body>
</html>