<!DOCTYPE html>
<html lang="es">
<head>
	<title>Registro</title>
	<link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
	<link type="text/css" rel="stylesheet" href="css/estilo.css"  media="screen,projection"/>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body>
    <div class="container-fluid">
	    <div class="navbar-fixed">
	        <nav>
	            <div class="nav-wrapper nav-bar-fixed blue darken-4">
					<ul class="left" id="arrowUl">
						<li><a onclick="window.location.replace('index.html')"><i class="material-icons" style="-ms-transform: rotate(180deg);-webkit-transform: rotate(180deg);transform: rotate(180deg);">trending_flat</i></a></li>
					</ul>
	                <a onclick="window.location.replace('registro.html')" class="brand-logo center">Registro</a>
	            </div>
	        </nav>
	    </div>
    </div>
    <div class="container">
		<div class="preloader-wrapper active" id="loader">
			<div class="spinner-layer spinner-blue-only">
				<div class="circle-clipper left">
					<div class="circle"></div>
				</div>
				<div class="gap-patch">
					<div class="circle"></div>
				</div>
				<div class="circle-clipper right">
					<div class="circle"></div>
				</div>
			</div>
		</div>
        <div class="card-panel blue lighten-5">

            <div class="row">

                <form class="col s12" id="form" onsubmit="return controlSubmit();">

                    <h6 class="black-text">Datos personales</h6>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="input-field col s6">
                        	<input type="hidden" id="id" />
                            <input id="first_name" type="text" onkeydown="sacarColor(this)" required>
                            <label for="first_name">Nombre</label>
                        </div>
                        <div class="input-field col s6">
                            <input id="last_name" type="text" onkeydown="sacarColor(this)" required>
                            <label for="last_name">Apellido</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                            <input id="dni" type="number" onkeydown="sacarColor(this)" onblur="checkDni()" placeholder="Sin puntos" required>
                            <label for="dni">DNI</label>
                        </div>
                        <div class="input-field col s6">
                            <!--<input id="loc" type="text" onkeydown="sacarColor(this)">-->
							<input type="date" id="fechanac" class="datepicker" placeholder="dd/mm/aaaa" required>
                            <label for="fechanac">Fecha Nac.</label>
                        </div>
                    </div>
					<div class="row">
						<div class="input-field col s12">
							<input type="hidden" id="idLocalidad" value=""/>
							<label class="active">Localidad</label>
							<input type="text" id="autocompleteState" class="autocomplete inputFields" required>
						</div>
					</div>
					<div class="row">
						<div class="input-field col s12">
							<select id="regional" onchange="getEspecialidad()">
							</select>
							<label>Regional</label>
						</div>
					</div>
					<div class="row">
						<div class="input-field col s12">
							<select id="especialidad">
							</select>
							<label>Especialidad</label>
						</div>
					</div>
                    <h6 class="black-text">Contacto</h6>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="email" type="email" onkeydown="sacarColor(this)" required>
                            <label for="email">Correo</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s6">
                        	<input type="hidden" id="carCId" />
                            <input id="carCel" type="text" onkeydown="sacarColor(this)" placeholder="Sin 0" required>
                            <label for="carCel">Caracter&iacute;stica</label>
                        </div>
                        <div class="input-field col s6">
                        	<input type="hidden" id="celId" />
                            <input id="cel" type="text" onkeydown="sacarColor(this)" placeholder="Sin 15" required>
                            <label for="cel">Celular</label>
                        </div>
                    </div>
					<div class="row">
						<div class="input-field col s6">
							<input type="hidden" id="carTId" />
							<input id="carFijo" type="text" onkeydown="sacarColor(this)" placeholder="Sin 0">
							<label for="carFijo">Caracter&iacute;stica</label>
						</div>
						<div class="input-field col s6">
							<input type="hidden" id="fijoId" />
							<input id="fijo" type="text" onkeydown="sacarColor(this)" placeholder="  ">
							<label for="fijo">Tel&eacute;fono fijo</label>
						</div>
					</div>

                    <h6 class="black-text">Datos de cuenta</h6>
                    <div class="divider"></div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="username" type="text" onkeydown="sacarColor(this)" required>
                            <label for="username">Nombre Usuario</label>
                        </div>
					</div>
					<div class="row">
						<div class="input-field col s6">
							<input placeholder="Al menos 6 caracteres" id="password" type="password" onkeydown="sacarColor(this)" pattern=".{6,}"  onchange="this.setCustomValidity(this.validity.patternMismatch ? 'Debe tener al menos 6 caracteres' : ''); if(this.checkValidity()) form.passwordRep.pattern = this.value; if(this.value.length > 0) {form.passwordRep.setAttribute('required',true);}else{if(form.password.getAttribute('required')){form.passwordRep.setAttribute('required',true);}else{form.passwordRep.setAttribute('required',false);}}">
							<label for="password">Contraseña</label>
						</div>
						<div class="input-field col s6">
							<input placeholder="Al menos 6 caracteres" id="passwordRep" type="password" onkeydown="sacarColor(this)" pattern=".{6,}" onchange="this.setCustomValidity(this.validity.patternMismatch ? 'Ingrese la misma contraseña' : '');">
							<label for="passwordRep">Repita Contraseña</label>
						</div>
					</div>

                    <div class="center-align">
                        <button class="btn waves-effect light-blue darken-3" type="submit" name="action">Registrarme
                            <i class="material-icons right">done</i>
                        </button>
                    </div>
                </form>
            </div>

        </div>
	</div>
<div class="footer-copyright right-align">
	<div class="container">
		<i>© 2016 UTN FRVM</i>
	</div>
</div>
    
<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="js/materialize.min.js"></script>
<script type="text/javascript" src="js/functions.js"></script>
<script defer>

let passRequired = false;
let regional,especialidad;
const l = new Loader();
function controlVacio(nombreSelector)
{
	if($.trim($(nombreSelector).val()) == '')
	{
		$(nombreSelector).css('box-shadow','0px 0px 1px 1px #f24d4d');
		$(nombreSelector).focus();
		return false;
	}
	return true;
}

function sacarColor(me)
{
	$(me).css('box-shadow','0px 0px 0px 0px #ccc');
}

function controlSubmit()
{
	if(!controlVacio('#first_name')) return false;
	if(!controlVacio('#last_name')) return false;
	if(!controlVacio('#dni')) return false;
	if(!controlVacio('#autocompleteState')) return false;
	if(!controlVacio('#email')) return false;
	if(!controlVacio('#username')) return false;
	if($('#regional').val() == "0") return false;
	if($('#especialidad').val() == "0") return false;
	if(passRequired)
	{
		if(!controlVacio('#password')) return false;
	}

	var birthDate = formatDate($('#fechanac').val());

	var param = {
		"id":($('#id').val()),
		"nombre":($('#first_name').val()),
		"apellido":($('#last_name').val()),
		"dni":($('#dni').val()),
		"localidad":($('#loc').val()),
		"email":($('#email').val()),
		"caracCel":($('#carCel').val()),
		"cel":($('#cel').val()),
		"caracFijo":($('#carFijo').val()),
		"fijo":($('#fijo').val()),
		"username":($('#username').val()),
		"passRequired": passRequired,
		"password":($('#password').val()),
		"celId":($('#celId').val()),
		"fijoId":($('#fijoId').val()),
		"birthDate":birthDate,
		"localidadId":($('#idLocalidad').val()),
		"regional":($('#regional').val()),
		"especialidad":($('#especialidad').val())
	}
	l.start();
	$.ajax({
		type:"POST",
		data: param,
		url: "http://extension.frvm.utn.edu.ar/graduadosApi/guardarDatos.php",
		success: function(response)
		{
			l.stop();
			const r = parse(response);
			if(r[0].success)
			{
				if(r[0].created == 't')
				{
					toasty('Se le enviará un mail cuando su usuario sea habilitado','info');
					setTimeout(move, 4000);
				}
				else
				{
					removeItem('primeravez');
					setItem('id', $('#id').val());
					redirect('inicio.html');
				}
			}
			else
			{
				toasty("No se pudo guardar",'error');
			}
		},
		error: function(msg)
		{
			l.stop();
			toasty("Hubo un error de conexión",'error');
		}
	});

	return false;
}

function move()
{
	redirect('index.html');
}

function getDatos()
{
	id = getItem('id');
	var param = {};
	param.id = (id != undefined) ? id : -1;
	if(id == -1 || id == null)
	{
		return;
	}
	else
	{
		$('#arrowUl').hide();
		$('.brand-logo').html('Confirmar datos');
	}
	l.start();
	$.ajax({
		type:"GET",
		url:"http://extension.frvm.utn.edu.ar/graduadosApi/getDataById.php",
		data: param,
		success: function(response)
		{
			successGetDatos(parse(response)[0]);
		},
		error: function(msg)
		{
			l.stop();
			toasty(`Hubo un error al buscar los datos. Problema de conexión`,'error');
		}
	});
}

function successGetDatos(data)
{
	if(data.primerLogin == 't')
	{
		passRequired = true;
		$('#password').prop('required',true);
		setItem('primeravez','t');
	}
	else
	{
		passRequired = false;
		$('#password').prop('required',false);
		setItem('primeravez','f');
	}

	$('#id').val(data.id);
	$('#first_name').val(data.nombre);
	$('#first_name').focus();
	$('#last_name').val(data.apellido);
	$('#last_name').focus();
	$('#dni').val(data.dni);
	$('#dni').focus();
	if(data.fechaNac != undefined)
	{
		var f = unformatDate(data.fechaNac);
		$('#fechanac').val(f);
	}
	$('#autocompleteState').val(data.localidad);
	$('#autocompleteState').focus();
	successGetRegional(regional,data.regional);
	getEspecialidad();
	$('#email').val(data.email);
	$('#email').focus();
	$('#celId').val(data.celId);
	$('#carCel').val(data.caracCel);
	$('#carCel').focus();
	$('#cel').val(data.cel);
	$('#cel').focus();
	$('#fijoId').val(data.fijoId);
	$('#carFijo').val(data.caracFijo);
	$('#carFijo').focus();
	$('#fijo').val(data.fijo);
	$('#fijo').focus();
	$('#username').val(data.username);
	$('#username').focus();
	$('#username').blur();

	if(data.id == "-1")
	{
		$('#dni').focus();
	}
	l.stop();
}

function checkDni()
{
	var dni = $('#dni').val().trim();
	if(dni != '')
	{
		if($('#id').val() == -1 || $('#id').val() == "")
		{
			
			const param = {
				dni
			};
			l.start();
			$.ajax({
				type:"POST",
				data: param,
				url:"http://extension.frvm.utn.edu.ar/graduadosApi/checkDni.php",
				success: function(response)
				{
					l.stop();
					var r = parse(response);
					if(r.length > 0)
					{
						successGetDatos(r[0]);
					}
					else
					{
						$('#id').val('-1');
						$('#first_name').focus();
					}
				},
				error: function(msg)
				{
					l.stop();
					toasty("Se ha generado un error al ir a buscar los datos por DNI. Problema de conexión",'error');
				}
			});
		}
	}
}

function successGetLocalidad(r)
{
	var localidadData = [];
	
	for(var i = 0; i < r.length; i++)
	{
		var obj = {value:r[i].name};
		localidadData.push(obj);
	}
	
	$('#autocompleteState').data('array', localidadData);
	
	var input_selector = 'input[type=text], input[type=password], input[type=email], input[type=url], input[type=tel], input[type=number], input[type=search], textarea';
	
	$(input_selector).each(function() {
		var $input = $(this);

		if ($input.hasClass('autocomplete'))
		{
			var $array = $input.data('array');
			var $inputDiv = $input.closest('.input-field'); // Div to append on
			if ($array !== '')
			{
				var $html = '<ul class="autocomplete-content hide" style="z-index:1;">';
				for (var i = 0; i < $array.length; i++)
				{
					if ($array[i]['path'] !== '' && $array[i]['path'] !== undefined && $array[i]['path'] !== null && $array[i]['class'] !== undefined && $array[i]['class'] !== '') {
						$html += '<li class="autocomplete-option"><img src="' + $array[i]['path'] + '" class="' + $array[i]['class'] + '"><span>' + $array[i]['value'] + '</span></li>';
					} else {
						$html += '<li class="autocomplete-option"><span>' + $array[i]['value'] + '</span></li>';
					}
				}
				$html += '</ul>';
				$inputDiv.append($html); // Set ul in body
				// End create html element
				
				var lengthWord = 0;
				// Perform search
				$(document).on('keyup', $input, function()
				{
					var quantity = 0;
					var $val = $input.val().trim(),
					$select = $('.autocomplete-content');
					
					$select.css('width',$input.width());

					var length = $val.length;
					if ($val != '' && $val.length >= 3 && length > lengthWord)
					{
						$select.children('li').addClass('hide');
						$select.children('li').filter(function()
						{
							$select.removeClass('hide');
							
							var check = true;
							if($(this).text().toLowerCase().indexOf($val.toLowerCase()) == -1)
							{
								check = false;
							}
							if(check)
							{
								if(quantity < 5)
								{
									quantity++;
								}
								else
								{
									check = false;
								}	
							}
							
							return check ? $(this).text().toLowerCase().indexOf($val.toLowerCase()) !== -1 : false;
						}).removeClass('hide');	
					}
					else
					{
						
						$select.children('li').addClass('hide');
					}
					lengthWord = length;
				});

				// Set input value
				$('.autocomplete-option').click(function()
				{
					$input.val($(this).text().trim());
					getIdLocalidad($(this).text().trim());
					$('.autocomplete-option').addClass('hide');
				});
			}
			else
			{
				return false;
			}
		}
	});
}

function getIdLocalidad(name)
{
	let vName = name.split(' - ');
	const localidad = vName[0];
	const provincia = vName[1];
	
	const param = {
		localidad,
		provincia
	};
	
	$.ajax({
		type:"POST",
		data:param,
		url:"http://extension.frvm.utn.edu.ar/graduadosApi/getLocalidadId.php",
		success: function(response)
		{
			var r = parse(response);
			if(r.length > 0)
			{
				$('#idLocalidad').val(r[0].id);
			}
			else
			{
				$('#autocompleteState').val('');
			}
		},
		error: function(msg)
		{
			console.log(msg);
		}
	});
}

function getDataLocalidad()
{
	$.ajax({
		type:'POST',
		url: 'http://extension.frvm.utn.edu.ar/graduadosApi/getLocalidad.php',
		success: function(response)
		{
			successGetLocalidad(parse(response));
		},
		error: function(msg)
		{
			toasty('Error al traer localidades.Problema de conexión','error');
		}
	});
}

function getEspecialidad()
{
	let param = {
		'regional':$('#regional').val()
	};
	
	$.ajax({
		type:"POST",
		url:"http://extension.frvm.utn.edu.ar/graduadosApi/getEspecialidad.php",
		data:param,
		success: function(response)
		{
			successGetEspecialidad(parse(response));
		},
		error: function(msg)
		{
			toasty('Error al traer las especialidades','error');
		}
	});
}

function successGetEspecialidad(data,val)
{
	if(data == undefined)
	{
		return;
	}
	
	val = (val == undefined) ? 0 : val;
	$('select').material_select('destroy');
	especialidad = data;
	htmlOptions = `<option value="0" disabled selected>Elija una especialidad</option>`;
	
	for(var i = 0; i < data.length; i++)
	{
		var id = data[i].id;
		var selected = '';
		if(id == val)
		{
			selected = ' selected ';
		}
		htmlOptions += `<option value="${id}"${selected}>${data[i].nombre}</option>`;
	}
	
	$('#especialidad').html(htmlOptions);
	$('select').material_select();
}

function getRegional()
{
	$.ajax({
		type:"POST",
		url:"http://extension.frvm.utn.edu.ar/graduadosApi/getRegional.php",
		success: function(response)
		{
			successGetRegional(parse(response));
		},
		error: function(msg)
		{
			toasty('Error al traer regionales.Problema de conexión','error');
		}
	});
}

function successGetRegional(data, val)
{
	if(data == undefined)
	{
		return;
	}
	
	val = (val == undefined) ? 0 : val;
	$('select').material_select('destroy');
	regional = data;
	htmlOptions = `<option value="0" disabled selected>Elija una regional</option>`;
	
	for(var i = 0; i < data.length; i++)
	{
		var id = data[i].id;
		var selected = '';
		if(id == val)
		{
			selected = ' selected ';
		}
		htmlOptions += `<option value="${id}"${selected}>${data[i].nombre}</option>`;
	}
	
	$('#regional').html(htmlOptions);
	$('select').material_select();
}

$(document).ready(function(){
	getDataLocalidad();
	getRegional();
	getDatos();
	$('.datepicker').pickadate({
		selectMonths: true, // Creates a dropdown to control month
		selectYears: 100 // Creates a dropdown of 15 years to control year
	});
});

</script>
</body>
</html>